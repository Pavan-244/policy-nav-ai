{% extends 'base.html' %}
{% block content %}
<h2 class="section-title mb-3">Financial News Visualizations</h2>
<div class="card mb-4">
  <div class="card-body">
    <div class="row g-3 align-items-end">
      <div class="col-md-4">
        <label class="form-label" for="fin-x-field">X Field</label>
        <select id="fin-x-field" class="form-select"></select>
      </div>
      <div class="col-md-3">
        <label class="form-label" for="fin-y-metric">Y Metric</label>
        <select id="fin-y-metric" class="form-select">
          <option value="count">Count</option>
          <option value="sum">Sum</option>
          <option value="avg">Average</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label" for="fin-value-field">Value Field (for Sum/Avg)</label>
        <select id="fin-value-field" class="form-select"></select>
      </div>
      <div class="col-md-2">
        <label class="form-label" for="fin-limit">Limit</label>
        <input id="fin-limit" type="number" class="form-control" min="3" max="50" value="10" />
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <canvas id="finBarChart" height="120"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
async function loadFields() {
  const res = await fetch('/financial/api/fields');
  const data = await res.json();
  const cat = data.categorical || [];
  const num = data.numeric || [];
  const xf = document.getElementById('fin-x-field');
  cat.forEach(c => xf.append(new Option(c, c)));
  const vf = document.getElementById('fin-value-field');
  vf.append(new Option('â€”', ''));
  num.forEach(n => vf.append(new Option(n, n)));
  if (cat.length) xf.value = cat[0];
}

async function loadBar() {
  const xField = document.getElementById('fin-x-field').value;
  const yMetric = document.getElementById('fin-y-metric').value;
  const valueField = document.getElementById('fin-value-field').value;
  const limit = document.getElementById('fin-limit').value || 10;
  const params = new URLSearchParams({ x_field: xField, y_metric: yMetric, limit });
  if (valueField) params.append('value_field', valueField);
  const res = await fetch(`/financial/api/chart-data?${params.toString()}`);
  const data = await res.json();
  return data;
}

let barChart;
function renderBar(labels, values) {
  const ctx = document.getElementById('finBarChart');
  barChart && barChart.destroy();
  barChart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Value', data: values, backgroundColor: 'rgba(79,70,229,0.5)' }] },
    options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
  });
}

async function refresh() {
  const bar = await loadBar();
  renderBar(bar.labels || [], bar.data || []);
}

loadFields().then(refresh);
['fin-x-field','fin-y-metric','fin-value-field','fin-limit'].forEach(id => document.getElementById(id).addEventListener('change', refresh));
</script>
{% endblock %}
