<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Healthcare Data Visualizations</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <h1>Healthcare Data Visualizations</h1>
    <nav>
        <a href="/">Search</a> | <a href="/visualizations">Visualizations</a>
    </nav>

    <!-- Controls Section -->
    <div class="controls">
        <h2>Chart Controls</h2>
        <label>
            Chart Type:
            <select id="chartType">
                <option value="condition">Medical Conditions</option>
                <option value="doctor">Doctors</option>
                <option value="hospital">Hospitals</option>
                <option value="age_group">Age Groups</option>
                <option value="gender">Gender</option>
                <option value="admission_type">Admission Types</option>
                <option value="test_results">Test Results</option>
            </select>
        </label>
        <label>
            Visualization:
            <select id="vizType">
                <option value="bar">Bar Chart</option>
                <option value="pie">Pie Chart</option>
                <option value="doughnut">Doughnut Chart</option>
                <option value="line">Line Chart</option>
            </select>
        </label>
        <label>
            Top Items:
            <input type="number" id="topLimit" value="10" min="5" max="20">
        </label>
        <button onclick="updateChart()">Update Chart</button>
    </div>

    <!-- Chart.js Section -->
    <section>
        <h2>Interactive Chart</h2>
        <canvas id="mainChart" width="800" height="400"></canvas>
    </section>

    <!-- D3.js Section -->
    <section>
        <h2>Billing Amount Distribution (D3.js)</h2>
        <button onclick="loadBillingChart()">Load Billing Histogram</button>
        <svg id="billingChart" width="800" height="400"></svg>
    </section>

    <script>
        let currentChart = null;

        // Color palette
        const colors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
            '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
        ];

        async function updateChart() {
            const chartType = document.getElementById('chartType').value;
            const vizType = document.getElementById('vizType').value;
            const limit = document.getElementById('topLimit').value;

            try {
                const response = await fetch(`/api/chart-data?chart_type=${chartType}&limit=${limit}`);
                const data = await response.json();

                // Destroy existing chart
                if (currentChart) {
                    currentChart.destroy();
                }

                // Create new chart
                const ctx = document.getElementById('mainChart').getContext('2d');
                currentChart = new Chart(ctx, {
                    type: vizType,
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Count',
                            data: data.data,
                            backgroundColor: colors.slice(0, data.labels.length),
                            borderColor: colors.slice(0, data.labels.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: `${chartType.replace('_', ' ').toUpperCase()} Distribution`
                            }
                        },
                        scales: vizType === 'pie' || vizType === 'doughnut' ? {} : {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error fetching chart data:', error);
            }
        }

        async function loadBillingChart() {
            try {
                const response = await fetch('/api/billing-stats');
                const result = await response.json();
                
                // Clear previous chart
                d3.select("#billingChart").selectAll("*").remove();
                
                // Create D3 histogram
                const data = result.data;
                const margin = {top: 20, right: 30, bottom: 40, left: 40};
                const width = 800 - margin.left - margin.right;
                const height = 400 - margin.top - margin.bottom;
                
                const svg = d3.select("#billingChart")
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);
                
                const x = d3.scaleLinear()
                    .domain(d3.extent(data))
                    .range([0, width]);
                
                const histogram = d3.histogram()
                    .domain(x.domain())
                    .thresholds(x.ticks(20));
                
                const bins = histogram(data);
                
                const y = d3.scaleLinear()
                    .domain([0, d3.max(bins, d => d.length)])
                    .range([height, 0]);
                
                svg.selectAll("rect")
                    .data(bins)
                    .enter()
                    .append("rect")
                    .attr("x", d => x(d.x0))
                    .attr("y", d => y(d.length))
                    .attr("width", d => x(d.x1) - x(d.x0) - 1)
                    .attr("height", d => height - y(d.length))
                    .attr("fill", "#36A2EB");
                
                // Add axes
                svg.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x));
                
                svg.append("g")
                    .call(d3.axisLeft(y));
                
                // Add labels
                svg.append("text")
                    .attr("x", width / 2)
                    .attr("y", height + margin.bottom)
                    .attr("text-anchor", "middle")
                    .text("Billing Amount ($)");
                
                svg.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 0 - margin.left)
                    .attr("x", 0 - (height / 2))
                    .attr("dy", "1em")
                    .attr("text-anchor", "middle")
                    .text("Frequency");
                    
            } catch (error) {
                console.error('Error loading billing chart:', error);
            }
        }

        // Load initial chart
        updateChart();
    </script>
</body>
</html>
